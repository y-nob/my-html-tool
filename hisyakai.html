<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“¸è¢«å†™ç•Œæ·±åº¦ï¼‹æ§‹å›³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ğŸ“¸è¢«å†™ç•Œæ·±åº¦ï¼‹æ§‹å›³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
  <div class="container">
    <p>ç„¦ç‚¹è·é›¢ã€Få€¤ã€è¢«å†™ä½“è·é›¢ã€ã‚»ãƒ³ã‚µãƒ¼ã‚µã‚¤ã‚ºã‹ã‚‰è¢«å†™ç•Œæ·±åº¦ã‚’è¨ˆç®—ã—ã€æ§‹å›³ã‚’SVGã§å›³ç¤ºã—ã¾ã™ã€‚</p>

    <label for="focalLength">ç„¦ç‚¹è·é›¢ (mm)</label>
    <input type="number" id="focalLength" value="50">

    <label for="fNumber">Få€¤</label>
    <input type="number" step="0.1" id="fNumber" value="2.8">

    <label for="subjectDistance">è¢«å†™ä½“ã¾ã§ã®è·é›¢ (m)</label>
    <input type="number" step="0.1" id="subjectDistance" value="5">

    <label for="sensor">ã‚»ãƒ³ã‚µãƒ¼ã‚µã‚¤ã‚º</label>
    <select id="sensor" onchange="updateSensorSpecs()">
      <option value="full">ãƒ•ãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ </option>
      <option value="aps_n">APS-C (Nikon/Sony)</option>
      <option value="aps_c">APS-C (Canon)</option>
      <option value="mft">MFT</option>
    </select>

    <label for="circleOfConfusion">è¨±å®¹éŒ¯ä¹±å††å¾„ (mm)</label>
    <input type="number" step="0.001" id="circleOfConfusion" value="0.030" readonly>

    <label for="sensorSize">ã‚»ãƒ³ã‚µãƒ¼ã‚µã‚¤ã‚º (mm)</label>
    <input type="text" id="sensorSize" value="36.0 Ã— 24.0" readonly>

    <button onclick="calculateAndRender()">è¨ˆç®—ï¼†æç”»</button>

    <div class="result" id="dofResult"></div>
    <div id="svgContainer" style="margin-top:20px; text-align:center;"></div>

    <p style="margin-top:20px;">
      <a href="index.html">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
    </p>
  </div>

  <script>
    const sensorSpecs = {
      "full":   { name: "ãƒ•ãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ ", coc: 0.030, width: 36.0, height: 24.0 },
      "aps_n":  { name: "APS-C (Nikon/Sony)", coc: 0.020, width: 23.6, height: 15.7 },
      "aps_c":  { name: "APS-C (Canon)", coc: 0.019, width: 22.3, height: 14.9 },
      "mft":    { name: "MFT", coc: 0.015, width: 17.3, height: 13.0 }
    };

    function updateSensorSpecs() {
      const key = document.getElementById("sensor").value;
      const spec = sensorSpecs[key];
      document.getElementById("circleOfConfusion").value = spec.coc.toFixed(3);
      document.getElementById("sensorSize").value = `${spec.width.toFixed(1)} Ã— ${spec.height.toFixed(1)}`;
    }

    function calculateAndRender() {
  const f = parseFloat(document.getElementById("focalLength").value); // mm
  const N = parseFloat(document.getElementById("fNumber").value);
  const s = parseFloat(document.getElementById("subjectDistance").value) * 1000; // m â†’ mm
  const key = document.getElementById("sensor").value;
  const spec = sensorSpecs[key];
  const c = spec.coc;
  const sensorW = spec.width;
  const sensorH = spec.height;

  if (isNaN(f) || isNaN(N) || isNaN(s) || isNaN(c)) {
    document.getElementById("dofResult").innerText = "ã™ã¹ã¦ã®é …ç›®ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
    return;
  }

  // è¢«å†™ç•Œæ·±åº¦è¨ˆç®—
  const H = (f * f) / (N * c) + f; // mm
  const Dn = (H * s) / (H + (s - f)); // mm
  const Df = (H * s) / (H - (s - f)); // mm

  const near = Dn / 1000; // m
  const far = Df > 0 ? Df / 1000 : Infinity;
  const total = (far === Infinity) ? "âˆ" : ((far - near).toFixed(3) + " m");

  // å·®åˆ†è¨ˆç®—ï¼ˆè¢«å†™ä½“ã‹ã‚‰ã®å‰å¾Œè·é›¢ï¼‰
  const nearDiff = (s / 1000 - near).toFixed(3); // m
  const farDiff = (far === Infinity) ? "âˆ" : (far - s / 1000).toFixed(3); // m

  // è¡¨ç¤º
  document.getElementById("dofResult").innerHTML = `
    <div class="result_matrix">
      ã‚»ãƒ³ã‚µãƒ¼ï¼š${spec.name}ï¼ˆ${sensorW}mm Ã— ${sensorH}mmï¼‰<br>
      è¨±å®¹éŒ¯ä¹±å††å¾„ï¼š${c.toFixed(3)} mm<br>
      å‰æ–¹è¢«å†™ç•Œæ·±åº¦ï¼š${near.toFixed(3)} mï¼ˆ${nearDiff} mï¼‰<br>
      å¾Œæ–¹è¢«å†™ç•Œæ·±åº¦ï¼š${far === Infinity ? "âˆ" : far.toFixed(3) + " m"}ï¼ˆ${farDiff} mï¼‰<br>
      è¢«å†™ç•Œæ·±åº¦ï¼š${total}
    </div>
  `;

  // æ§‹å›³æç”»
  const d = s / 1000; // mm â†’ m
  const thetaH = 2 * Math.atan(sensorW / (2 * f));
  const thetaV = 2 * Math.atan(sensorH / (2 * f));
  const viewW = 2 * d * Math.tan(thetaH / 2); // m
  const viewH = 2 * d * Math.tan(thetaV / 2); // m

  const subjectW = 0.6; // m
  const subjectH = 1.7; // m

  const scale = 300 / viewH;
  const svgW = viewW * scale;
  const svgH = viewH * scale;
  const subjW = subjectW * scale;
  const subjH = subjectH * scale;
  const subjX = (svgW - subjW) / 2;
  const subjY = (svgH - subjH) / 2;

  const nearY = svgH * (1 - (near / d));
  const farY = svgH * (1 - (far / d));

  const svg = `
    <svg width="${svgW}" height="${svgH}" style="border:1px solid #999;">
      <rect x="0" y="0" width="${svgW}" height="${svgH}" fill="#f0f0f0" />

      <!-- å‰æ–¹DOFå¸¯ -->
      <rect x="0" y="${nearY}" width="${svgW}" height="${svgH - nearY}" fill="#d4edda" opacity="0.5" />

      <!-- å¾Œæ–¹DOFå¸¯ -->
      <rect x="0" y="${farY}" width="${svgW}" height="${svgH - farY}" fill="#f8d7da" opacity="0.5" />

      <!-- è¢«å†™ä½“ -->
      <rect x="${subjX}" y="${subjY}" width="${subjW}" height="${subjH}" fill="#007bff" opacity="0.6" />
      <text x="${subjX + 5}" y="${subjY + 20}" font-size="14" fill="#333">è¢«å†™ä½“</text>
    </svg>
    <p class="result_matrix">
      ã‚»ãƒ³ã‚µãƒ¼ã«å†™ã‚‹ç¯„å›²ï¼š${viewW.toFixed(2)}m Ã— ${viewH.toFixed(2)}m<br>
      è¢«å†™ä½“ã‚µã‚¤ã‚ºï¼š0.6m Ã— 1.7m
    </p>
  `;

  document.getElementById("svgContainer").innerHTML = svg;
}


    // åˆæœŸåŒ–
    window.onload = updateSensorSpecs;
  </script>
</body>
</html>
